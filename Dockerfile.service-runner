ARG BASE_IMAGE=node:18-buster
# Base of build ###################################################
FROM $BASE_IMAGE as base
RUN apt update && apt-get -y install sqlite3 python3 python3-pip python3-setuptools vim curl telnet
RUN pip3 install --upgrade pip awscli awscli-local
# Need to downgrade boto3 because there is a bug breaking creating SQS queues
RUN pip3 install boto3==1.25.5
RUN corepack enable
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH:node_modules/bin"
RUN pnpm config set store-dir /.pnpm-store

# Fetch dependencies ##############################################
FROM base as deps
WORKDIR /service-runner/
COPY ./*.json .
COPY ./*.yaml .
RUN mkdir -p /service-runner/services/service-runner
COPY services/service-runner/package.json /service-runner/services/service-runner
RUN mkdir -p /service-runner/services/harmony
COPY services/harmony/package.json /service-runner/services/harmony
RUN mkdir -p /service-runner/packages/util
COPY packages/util/package.json /service-runner/packages/util/package.json
RUN --mount=type=cache,id=pnpm,target=/.pnpm-store pnpm install -r --frozen-lockfile

# Build the project ###############################################
FROM deps AS builder

COPY ./packages ./packages
COPY ./services/service-runner ./services/service-runner
COPY ./services/harmony ./services/harmony

# Copy directories needed by service-runner
COPY ./db ./db

# Compile the TypeScript
RUN pnpm run -r bld

# Delete non-production node_modules and TypeScript source code
RUN yes | pnpm prune --prod --no-optional
RUN find /service-runner -name "*.ts" -type f -delete

# Build the service image #########################################
FROM builder AS service
ARG PORT=5000
RUN mkdir -p /tmp/metadata
WORKDIR "/service-runner/services/service-runner"
RUN cp -rf /service-runner/db/* ../harmony/db
EXPOSE $PORT
CMD [ "node", "app/server.js" ]
