#!/bin/bash

SELF=$(basename $0)

function usage
{
  echo "Usage: $SELF [-c|--create] [-d|--driver <driver>] [port]"

  echo "port must be a number"
}

CREATE=false

while [[ $# -gt 0 ]]
do
key="$1"

case $key in
  -c|--create)
  CREATE=true
  shift
  ;;
  -d|--driver)
  DRIVER=$2
  shift
  shift
  ;;
  *)
  PORT="$1"
  shift
  ;;
esac
done

# make sure we are talking to minikube and not some other environment
kubectl config use-context minikube

# use docker driver as the default
DRIVER_DEFAULT=docker

DRIVER=${DRIVER:-$DRIVER_DEFAULT}

PORT=${PORT:-2746}

[[ $PORT =~ ^[0-9]+$ ]] || (usage && exit 1)

echo "$DRIVER"

minikube start --driver="$DRIVER"

sleep 5

if [[ "$CREATE" = true ]]
  then
    kubectl create ns argo
    kubectl apply -n argo -f https://raw.githubusercontent.com/argoproj/argo/stable/manifests/quick-start-postgres.yaml
fi 

# wait for argo to start up
while [[ $(kubectl -n argo get pods -l app=argo-server -o 'jsonpath={..status.conditions[?(@.type=="Ready")].status}') != "True" ]]; do echo "waiting for argo" && sleep 5; done

if [[ "$CREATE" = true ]]
  then
  # create the workflow template for harmony-gdal
  argo -n argo template create ./config/workflow-templates/harmony-gdal.yaml
fi

kubectl -n argo port-forward deployment/argo-server "$PORT:2746"