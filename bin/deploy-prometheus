#!/bin/bash
# create Prometheus deployment

env_save=$(export -p)
set -a
source "env-defaults"
source ".env"
set +a
eval "$env_save"

envsubst < "config/prometheus.yaml" | kubectl apply -f -

# Create a temp directory to hold the certificates
tmp_dir=$(mktemp -d)
echo $tmp_dir
 
SERVICE_NAME="custom-metrics-apiserver"
ALT_NAMES="\"custom-metrics-apiserver.monitoring\",\"custom-metrics-apiserver.monitoring.svc\""
CMD="openssl req -x509 -sha256 -new -nodes -days 365 -newkey rsa:2048 -keyout metrics-ca.key -out metrics-ca.crt -subj \"/CN=ca\"; \
	 echo '{\"signing\":{\"default\":{\"expiry\":\"43800h\",\"usages\":[\"signing\",\"key encipherment\",\"'metrics'\"]}}}' > \"metrics-ca-config.json\"; \
	 echo '{\"CN\":\"'${SERVICE_NAME}'\",\"hosts\":[${ALT_NAMES}],\"key\":{\"algo\":\"rsa\",\"size\":2048}}' > metrics-ca-crs.json; \
	 cat metrics-ca-crs.json; \
     cfssl gencert -ca=metrics-ca.crt -ca-key=metrics-ca.key -config=metrics-ca-config.json metrics-ca-crs.json | \
     cfssljson -bare /workdir/mm"

docker run --entrypoint=/bin/bash \
    -v $tmp_dir:/workdir/ \
    -i cfssl/cfssl \
    -c "${CMD}"

# Remove the temp directory
rm -rf $tmp_dir
