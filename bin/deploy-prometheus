#!/bin/bash

env_save=$(export -p)
set -a
source "env-defaults"
if [ -f ".env" ]; then
source ".env"
fi
set +a
eval "$env_save"

# Deploy prometheus
envsubst < "config/prometheus.yaml" | kubectl apply -f -

# Check for helm
if ! command -v "helm" &> /dev/null; then
    echo "'helm' command not found. Prometheus adapter needs to be deployed via helm."
    exit 1;
fi

# Deploy prometheus adapter
PROMETHEUS_NAMESPACE=monitoring
PROMETHEUS_ADAPTER_HELM_NAME=harmony-prometheus-adapter
if [[ `helm list -q -n ${PROMETHEUS_NAMESPACE} -f ${PROMETHEUS_ADAPTER_HELM_NAME}` \
        = ${PROMETHEUS_ADAPTER_HELM_NAME} ]]; then
    echo "deleteing previous helm installation"
    helm delete ${PROMETHEUS_ADAPTER_HELM_NAME} -n ${PROMETHEUS_NAMESPACE}
fi
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update
helm install -f ./config/prometheus-adapter-helm-values.yaml \
                -n ${PROMETHEUS_NAMESPACE} \
                ${PROMETHEUS_ADAPTER_HELM_NAME} \
                prometheus-community/prometheus-adapter