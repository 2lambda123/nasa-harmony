#!/bin/bash
# deploy horizontal pod autoscalers for locally deployed services and query-cmr

env_save=$(export -p)
set -a
source "env-defaults"
if [ -f ".env" ]; then
source ".env"
fi
set +a
eval "$env_save"

file="config/hpa.yaml"

# create the query-cmr autoscaler
echo "Deploying HPA for query-cmr"
export SERVICE_NAME="query-cmr"
envsubst < $file | kubectl apply -f - -n harmony

# create the other autoscalers
for service in ${LOCALLY_DEPLOYED_SERVICES//,/ }
do
  # set up enviornment variables for service
  export SERVICE_NAME=${service}
  echo "Deploying HPA for $service"
  envsubst < $file | kubectl apply -f - -n harmony
done
