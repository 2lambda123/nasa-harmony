#!/bin/bash

set -e

if [ -f .env ]; then
  set -o allexport
  source .env
  set +o allexport
fi
stagingBucket="${STAGING_BUCKET:-local-staging-bucket}"
uploadBucket="${UPLOAD_BUCKET:-local-upload-bucket}"
echo "Starting localstack and creating staging bucket s3://$stagingBucket and temp bucket s3://$uploadBucket"

export AWS_DEFAULT_REGION=us-west-2
export AWS_ACCESS_KEY_ID=fake
export AWS_SECRET_ACCESS_KEY=fake

if [[ "$(docker images -q localstack/localstack 2> /dev/null)" == "" ]]; then
  docker pull localstack/localstack
fi
make_bucket=0
while read -r line ; do
  if [[ "$line" == *Ready.* ]] && [[ $make_bucket -eq 0 ]]; then
    aws --endpoint-url=http://localhost:4572 s3 mb s3://$stagingBucket > /dev/null
    aws --endpoint-url=http://localhost:4572 s3 mb s3://$uploadBucket > /dev/null
    for queue in $(sed -n -e 's/^[[:space:]]*queue_url:.*}//p' config/services.yml); do
      aws --endpoint-url=http://localhost:4576 sqs create-queue --queue-name $queue > /dev/null
    done
    make_bucket=1
  fi
  echo "$line"
done < <(docker run --rm -it -e SERVICES=s3,sqs,sts -e DEBUG=1 -p 4566:4566 -p 4572:4572 -p 4576:4576 -p 4592:4592 localstack/localstack)
